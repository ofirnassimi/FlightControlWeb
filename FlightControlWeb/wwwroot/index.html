<!DOCTYPE html>
<html>
<head>
    <title>My Google Map</title>
    <meta name="viewport" content="initial-scale=1.0, user-scalable=no">
    <meta charset="utf-8">
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>

    <style>
        #map {
            height: 400px;
            width: 50%;
        }

        ul {
            columns: 2;
            -webkit-columns: 2;
            -moz-columns: 2;
        }

        .columns {
            float: left;
            position: relative;
            margin-right: 20px;
        }

        table {
            border: 1px solid gray;
            width: 50%;
            text-align: center;
        }

        table#flights-table tbody tr {
            background-color: #ffccff;
            cursor: pointer;
        }


        /*th, td {
            border: 1px solid black;
            border-collapse: collapse;
        }*/
    </style>
    <link rel="shortcut icon" href="">
</head>
<body>
    <p>This is a paragraph.</p>
    <p>This is another paragraph.</p>
    <button>Click me</button>
    <div id="map"></div>

    <ul id="flight-plan-details-ul">
        <li id="flight-id-li">
            <div>
                Flight ID:
            </div>
            <div id="flight-id-value">

            </div>
        </li>
        <li id="boarding-location-li">
            <div>
                Boarding Location:
            </div>
            <div id="boarding-location-value">

            </div>
        </li>
        <li id="landing-location-li">
            <div>
                Landing Location:
            </div>
            <div id="landing-location-value">

            </div>
        </li>
        <li id="boarding-time-li">
            <div>
                Boarding Time:
            </div>
            <div id="boarding-time-value">

            </div>
        </li>
        <li id="landing-time-li">
            <div>
                Landing Time:
            </div>
            <div id="landing-time-value">

            </div>
        </li>
        <li id="company-name-li">
            <div>
                Company Name:
            </div>
            <div id="company-name-value">

            </div>
        </li>
        <li id="passengers-li">
            <div>
                Passengers:
            </div>
            <div id="passengers-value">

            </div>
        </li>
    </ul>

    <table id="flights-table">
        <thead>
            <tr class="rows">
                <th>Flight ID</th>
                <th>Company Name</th>
                <th>Boarding Time</th>
                <th>Is External</th>
            </tr>
        </thead>
        <tbody>
            <!-- To be filled by JavaScript -->
        </tbody>
    </table>

    <script>
        let serversArray;
        let flightsArray;
        let flightPlansArray = [];
        let markersArray = [];
        let map;
        let flightPath;

        const flightsTableBody = document.querySelector("#flights-table > tbody");

        $(document).ready(function () {
            $("button").click(function () {
                $("p").hide();
            });
        });

        

        //window.onload = addRowHandlers();

        async function startApplication() {
            await initPageData();
            initMap();
            initFlightsTable();
        }

        function initMap() {
            let myLocation = { lat: 32.005443, lng: 34.885545 };

            const mapBounds = {
                north: 85,
                south: -85,
                west: -180,
                east: 180
            };

            map = new google.maps.Map(document.getElementById('map'), {
                zoom: 8,
                center: myLocation,
                restriction: {
                    latLngBounds: mapBounds,
                    strictBounds: true
                }
            });

            addFlightsMarkersToMap(map);

            map.addListener('click', function () {
                initMarkers();
            })

            showFlightsMarkers(map);
        }

        async function initPageData() {
            await initServers();
            await fetchFlights();
            await fetchFlightPlans();
        }

        async function initServers() {
            const response = await fetch('https://localhost:44308/api/servers')
                .then(response => response.json());
            serversArray = response;
        }

        async function fetchFlights(dateString) {
            let date;

            //dateString ? date = dateString : date = (new Date()).toISOString();
            dateString ? date = dateString : date = '2020-05-24T09:03:50Z';

            //'2020-05-24T09:40:35Z'
            const url = `https://localhost:44308/api/Flights?relative_to=${date}&sync_all`;
            const response = await fetch(url).then(response => response.json());
            flightsArray = response;
        }

        function addFlightsMarkersToMap() {
            let props = {};

            for (let i = 0; i < flightsArray.length; i++) {
                props.location = {
                    lat: flightsArray[i].Latitude,
                    lng: flightsArray[i].Longitude
                };

                props.map = map;
                props.flightId = flightsArray[i].FlightId;

                addMarker(props);
            }
        }

        function updateMarker(marker) {
            let newLatLng;

            for (let i = 0; i < flightsArray.length; i++) {
                if (marker.flightId == flightsArray[i].FlightId) {
                    newLatLng = new google.maps.LatLng(flightsArray[i].Latitude, flightsArray[i].Longitude);
                    marker.setPosition(newLatLng);
                }
            }
        }

        function addMarker(props) {
            let marker = new google.maps.Marker({
                position: props.location,
                map: props.map,
                flightId: props.flightId
            });

            marker.setIcon('img/blackPlane.png');

            marker.addListener('click', function () {
                if (marker.icon === 'img/blackPlane.png') {
                    const flightPlan = flightPlansArray.find(fp => fp.FlightId === marker.flightId);

                    initMarkers();
                    marker.setIcon('img/coloredPlane.png');
                    showFlightPath(flightPlan);
                    updateFlightPlanTable(flightPlan);
                } else {
                    marker.setIcon('img/blackPlane.png');
                    removeFlightPath();
                    clearFlightPlanDetailsUl();
                }

                console.log(marker.position);
            });

            markersArray.push(marker);
            initFlightsTable();
        }

        async function fetchFlightPlans() {
            let flightId;

            for (let i = 0; i < flightsArray.length; i++) {
                if (!flightPlansArray.some(plan => plan.FlightId === flightsArray[i].FlightId)) {
                    flightId = flightsArray[i].FlightId;
                    const url = 'https://localhost:44308/api/FlightPlan/' + flightId;
                    const response = await fetch(url).then(response => response.json());
                    flightPlansArray.push(response);
                }
            }
        }

        async function showFlightsMarkers() {
            //let date = (new Date()).toISOString();
            //'2020-05-24T09:40:35Z'
            let date = new Date('2020-05-24T09:04:30Z');
            let dateString;

            while (true) {
                dateString = date.toISOString();

                await fetchFlights(dateString);
                await fetchFlightPlans();

                date.setSeconds(date.getSeconds() + 1);

                await sleep(1000);

                handleMarkers();
            }
        }

        function sleep(ms) {
            return new Promise(resolve => setTimeout(resolve, ms));
        }

        function handleMarkers() {
            removeIrrelevantMarkers();

            for (let i = 0; i < flightsArray.length; i++) {
                if (markersArray.some(marker => marker.flightId === flightsArray[i].FlightId)) {
                    updateMarker(markersArray[i]);
                } else {
                    let props = {};

                    props.location = {
                        lat: flightsArray[i].Latitude,
                        lng: flightsArray[i].Longitude
                    };

                    props.map = map;
                    props.flightId = flightsArray[i].FlightId;

                    addMarker(props);
                }
            }
        }

        function removeIrrelevantMarkers() {
            const markersArrayInitialLength = markersArray.length;

            for (let i = 0; i < markersArrayInitialLength; i++) {
                if (!flightsArray.some(flight => flight.FlightId === markersArray[i].flightId)) {
                    markersArray[i].setMap(null);
                    markersArray.splice(i, 1);
                    removeFlightPath();
                    initFlightsTable();
                    clearFlightPlanDetailsUl();
                    break;
                }
            }
        }

        function showFlightPath(flightPlan) {
            const segments = [];

            segments.push({
                lat: flightPlan.InitialLocation.Latitude,
                lng: flightPlan.InitialLocation.Longitude
            });

            for (let i = 0; i < flightPlan.Segments.length; i++) {
                segments.push({
                    lat: flightPlan.Segments[i].Latitude,
                    lng: flightPlan.Segments[i].Longitude
                });
            }

            flightPath = new google.maps.Polyline({
                path: segments,
                geodesic: true,
                strokeColor: '#060054',
                strokeOpacity: 1.0,
                strokeWeight: 2
            });

            flightPath.setMap(map);
        }

        function removeFlightPath() {
            if (flightPath) {
                flightPath.setMap(null);
            }
        }

        function initMarkers() {
            for (let i = 0; i < markersArray.length; i++) {
                markersArray[i].setIcon('img/blackPlane.png');
                clearFlightPlanDetailsUl();
            }

            removeFlightPath();
        }

        function updateFlightPlanTable(flightPlan) {
            const boardingLat = flightPlan.InitialLocation.Latitude;
            const boardingLng = flightPlan.InitialLocation.Longitude;
            const landingLat = flightPlan.Segments[flightPlan.Segments.length - 1].Latitude;
            const landingLng = flightPlan.Segments[flightPlan.Segments.length - 1].Longitude;
            const landingTime = calculateLandingTime(flightPlan);

            document.getElementById("flight-id-value").innerHTML = flightPlan.FlightId;
            document.getElementById("boarding-location-value").innerHTML = boardingLat + ', ' + boardingLng;
            document.getElementById("landing-location-value").innerHTML = landingLat + ', ' + landingLng;
            document.getElementById("boarding-time-value").innerHTML = flightPlan.InitialLocation.DateTime;
            document.getElementById("landing-time-value").innerHTML = landingTime;
            document.getElementById("company-name-value").innerHTML = flightPlan.CompanyName;
            document.getElementById("passengers-value").innerHTML = flightPlan.Passengers;

        }

        function calculateLandingTime(flightPlan) {
            let landingTime = new Date(flightPlan.InitialLocation.DateTime);
            let segments = flightPlan.Segments;

            for (let i = 0; i < segments.length; i++) {
                landingTime.setSeconds(landingTime.getSeconds() + segments[i].TimespanSeconds);
            }

            return landingTime;
        }

        

        function initFlightsTable() {
            clearFlightsTable();

            // Show only internal flights
            flightsArray.forEach((flight) => {
                if (!flight.IsExternal) {
                    addFligthToTable(flight);
                }
            });

            // Show only external flights
            flightsArray.forEach((flight) => {
                if (flight.IsExternal) {
                    addFligthToTable(flight);
                }
            });

            handleFlightsTable();
        }

        function addFligthToTable(flight) {
            const tr = document.createElement("tr");

            //Flight ID
            const td = document.createElement("td");
            td.textContent = flight.FlightId;
            tr.appendChild(td);

            //Company Name
            const td1 = document.createElement("td");
            td1.textContent = flight.CompanyName;
            tr.appendChild(td1);

            //Boarding Time
            const td2 = document.createElement("td");
            td2.textContent = flight.DateTime;
            tr.appendChild(td2);

            //Is External
            const td3 = document.createElement("td");
            td3.textContent = flight.IsExternal;
            tr.appendChild(td3);

            flightsTableBody.appendChild(tr);
        }

        function clearFlightPlanDetailsUl() {
            document.getElementById("flight-id-value").innerHTML = "";
            document.getElementById("boarding-location-value").innerHTML = "";
            document.getElementById("landing-location-value").innerHTML = "";
            document.getElementById("boarding-time-value").innerHTML = "";
            document.getElementById("landing-time-value").innerHTML = "";
            document.getElementById("company-name-value").innerHTML = "";
            document.getElementById("passengers-value").innerHTML = "";
        }

        function clearFlightsTable() {
            let tableRef = document.getElementById("flights-table");
            while (tableRef.rows.length > 1) {
                tableRef.deleteRow(1);
            }
        }

        function handleFlightsTable() {
            let pickeduprow;

            $(document).ready(function () {
                $("#flights-table tbody tr").on("click", function (event) {

                    // First click
                    if (pickeduprow == null) {
                        pickeduprow = $(this);
                        pickeduprow.css("background-color", "red");

                        let rowFlightId = $(this).find("td").eq(0).html();

                        handleRowMarker(rowFlightId);

                    } else {
                        // This row is already clicked (find if IDs are equal)
                        if ($(this).find("td").eq(0).html() == pickeduprow.find("td").eq(0).html()) {
                            $(this).css("background-color", "#ffccff");
                            handleRowMarker($(this).find("td").eq(0).html());
                        } else {
                            pickeduprow.css("background-color", "#ffccff");
                            pickeduprow = $(this);
                            pickeduprow.css("background-color", "red");
                            handleRowMarker($(this).find("td").eq(0).html());
                        }
                    }
                });
            });
        }

        function handleRowMarker(rowFlightId) {
            const marker = markersArray.find(flightMarker => flightMarker.flightId === rowFlightId);
            if (marker.icon === 'img/blackPlane.png') {
                const flightPlan = flightPlansArray.find(fp => fp.FlightId === marker.flightId);

                initMarkers();
                marker.setIcon('img/coloredPlane.png');
                showFlightPath(flightPlan);
                updateFlightPlanTable(flightPlan);
            } else {
                marker.setIcon('img/blackPlane.png');
                removeFlightPath();
                clearFlightPlanDetailsUl();
            }
        }

    </script>
    <script async defer
            src="https://maps.googleapis.com/maps/api/js?key=AIzaSyBPKnpO09dXaCNjbl5fiW2R16yuodWiRXw&callback=startApplication">
                //src="https://maps.googleapis.com/maps/api/js?key=AIzaSyBPKnpO09dXaCNjbl5fiW2R16yuodWiRXw&callback=initMap">
    </script>
</body>
</html>