<!DOCTYPE html>
<html>
<head>
    <title>My Google Map</title>
    <meta name="viewport" content="initial-scale=1.0, user-scalable=no">
    <meta charset="utf-8">
    <style>
        #map {
            height: 400px;
            width: 50%;
        }
    </style>
    <link rel="shortcut icon" href="" >
</head>
<body>
    <div id="map"></div>
    <script>
        let serversArray;
        let flightsArray;
        let flightPlansArray = [];
        let markersArray = [];

        async function startApplication() {
            await initPageData();
            initMap();
            //showFlightsMarkers(map);
        }

        function initMap() {
            let myLocation = { lat: 32.005443, lng: 34.885545 };
            let map = new google.maps.Map(document.getElementById('map'), {
                zoom: 8,
                center: myLocation
            });

            addFlightsMarkersToMap(map);            

            //not working!!!!!!!!!
            /*google.maps.event.addListener(map, 'click', function () {
                markers[i].setIcon('img/blackPlane.png');
                console.log("after changing picture");
            });*/

            showFlightsMarkers(map);
        }

        async function initPageData() {
            await initServers();
            await fetchFlights();
            await initFlightPlans();
        }

        async function initServers() {
            const response = await fetch('https://localhost:44308/api/servers')
                    .then(response => response.json());
            serversArray = response;
        }

        async function fetchFlights(dateString) {
            let date;

            //dateString ? date = dateString : date = (new Date()).toISOString();
            dateString ? date = dateString : date = '2020-05-24T09:40:35Z';
            
            //'2020-05-24T09:40:35Z'
            const url = `https://localhost:44308/api/Flights?relative_to=${date}&sync_all`;
            const response = await fetch(url).then(response => response.json());
            flightsArray = response;
        }

        function addFlightsMarkersToMap(map) {
            let props = {};

            for (let i = 0; i < flightsArray.length; i++) {
                props.location = {
                    lat: flightsArray[i].Latitude,
                    lng: flightsArray[i].Longitude
                };

                props.map = map;
                props.flightId = flightsArray[i].FlightId;

                addMarker(props);
            }
        }

        function updateMarkers() {
            for (let i = 0; i < markersArray.length; i++) {
                markersArray[i].position = {
                    lat: flightsArray[i].location.Latitude,
                    lng: flightsArray[i].location.Longitude
                };
            }
        }

        function addMarker(props) {
            let marker = new google.maps.Marker({
                position: props.location,
                map: props.map
            });

            marker.setIcon('img/blackPlane.png');

            marker.addListener('click', function () {
                marker.setIcon('img/coloredPlane.png');
            });

            markersArray.push(marker);
        }

        async function initFlightPlans() {
            let flightId;

            for (let i = 0; i < flightsArray.length; i++) {
                flightId = flightsArray[i].FlightId;
                const url = 'https://localhost:44308/api/FlightPlan/' + flightId;
                const response = await fetch(url).then(response => response.json());
                flightPlansArray.push(response);
            }

            console.log(flightPlansArray);
        }

        async function showFlightsMarkers(map) {
            //let date = (new Date()).toISOString();
            //'2020-05-24T09:40:35Z'
            let date = new Date('2020-05-24T09:40:35Z');
            let dateString;

            while (true) {
                dateString = date.toISOString();

                fetchFlights(dateString);

                date.setSeconds(date.getSeconds() + 1);

                await sleep(1000);

                addFlightsMarkersToMap(map);
                //updateMarkers();
            }
        }

        function sleep(ms) {
            return new Promise(resolve => setTimeout(resolve, ms));
        }

    </script>
    <script async defer
            src="https://maps.googleapis.com/maps/api/js?key=AIzaSyBPKnpO09dXaCNjbl5fiW2R16yuodWiRXw&callback=startApplication">
            //src="https://maps.googleapis.com/maps/api/js?key=AIzaSyBPKnpO09dXaCNjbl5fiW2R16yuodWiRXw&callback=initMap">
    </script>
</body>
</html>