<!DOCTYPE html>
<html>
<head>
    <title>My Google Map</title>
    <meta name="viewport" content="initial-scale=1.0, user-scalable=no">
    <meta charset="utf-8">
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>

    <style>
        #wrapper {
            display: flex;
        }

        #map {
            height: 400px;
            width: 50%;
            flex: 0 0 55%;

        }

        /*ul {
            columns: 2;
            -webkit-columns: 2;
            -moz-columns: 2;
        }*/

        .columns {
            float: left;
            position: relative;
            margin-right: 20px;
        }

       

        #drop-area {
            border: 2px dashed #ccc;
            font-family: sans-serif;
            flex: 1;
            margin-left: 40px;
            margin-right: 40px;
            border-radius: 20px;
        }

            #drop-area.highlight {
                border-color: purple;
            }

        #flights-table {
            width: 100%;
            overflow: auto;
            text-align: center;
            border-collapse: collapse;
            border-radius: 10px;
        }

        table#flights-table tbody tr {
            cursor: pointer;
        }

        table#flights-table tbody th {
            padding: 1em;
            background: #ddd;
            border-bottom: 2px solid white;

        }

        table#flights-table tbody td {
            /*padding: 1em;*/
            border-bottom: 2px solid white;
        }

        /*body {
            margin: 1.5em;
        }*/

        #fileElem {
            display: none;
        }

        th, td {
            border: 1px solid black;
            border-collapse: collapse;
        }

        th {
            background-color: #ffb6c1;
        }

        #flight-plan-details-ul {
            background: #dcdcdc;
            margin-top: 20px;
            margin-right: 65%;
            list-style-type: none;
            font-family: sans-serif;
            border-radius: 10px;
        }

        #flight-plan-details-ul li {
            padding-bottom: 7px;
        }

        /*#drop-area {
            border: 2px dashed #ccc;
            border-radius: 20px;
            width: 480px;
            font-family: sans-serif;
            margin: 100px auto;
            padding: 20px;
            display: none;
        }

        #drop-area.highlight {
            border-color: purple;
        }

        .my-form {
            margin-bottom: 10px;
        }*/

    </style>
    <link rel="shortcut icon" href="">
</head>
<body>
    <div id="wrapper">
        <div id="map"></div>
        <div id="drop-area">
            <form class="my-form">
                <input type="file" id="fileElem" multiple accept="json/*" onchange="handleFiles(this.files)">
                <table id="flights-table">
                    <thead>
                        <tr class="rows">
                            <th></th>
                            <th>Flight ID</th>
                            <th>Company Name</th>
                            <th>Boarding Time</th>
                            <th>Is External</th>
                        </tr>
                    </thead>
                    <tbody id="flights-table-body">
                        <!-- To be filled by JavaScript -->
                    </tbody>
                </table>
            </form>
        </div>
    </div>

    <ul id="flight-plan-details-ul">
        <li id="flight-id-li">
            <div>
                Flight ID:
            </div>
            <div id="flight-id-value">

            </div>
        </li>
        <li id="boarding-location-li">
            <div>
                Boarding Location:
            </div>
            <div id="boarding-location-value">

            </div>
        </li>
        <li id="landing-location-li">
            <div>
                Landing Location:
            </div>
            <div id="landing-location-value">

            </div>
        </li>
        <li id="boarding-time-li">
            <div>
                Boarding Time:
            </div>
            <div id="boarding-time-value">

            </div>
        </li>
        <li id="landing-time-li">
            <div>
                Landing Time:
            </div>
            <div id="landing-time-value">

            </div>
        </li>
        <li id="company-name-li">
            <div>
                Company Name:
            </div>
            <div id="company-name-value">

            </div>
        </li>
        <li id="passengers-li">
            <div>
                Passengers:
            </div>
            <div id="passengers-value">

            </div>
        </li>
    </ul>

    <p id="json-upload-error"></p>

    <script>
        let serversArray;
        let flightsArray;
        let flightPlansArray = [];
        let markersArray = [];
        let map;
        let flightPath;
        let pickeduprow;

        const flightsTableBody = document.querySelector("#flights-table > tbody");

        async function startApplication() {
            await initPageData();
            initMap();
            initFlightsTable();

            dragAndDrop();
        }

        function initMap() {
            let myLocation = { lat: 32.005443, lng: 34.885545 };

            const mapBounds = {
                north: 85,
                south: -85,
                west: -180,
                east: 180
            };

            map = new google.maps.Map(document.getElementById('map'), {
                zoom: 8,
                center: myLocation,
                restriction: {
                    latLngBounds: mapBounds,
                    strictBounds: true
                }
            });

            addFlightsMarkersToMap(map);

            map.addListener('click', function () {
                initMarkers();

                for (let i = 0; i < markersArray.length; i++) {
                    let marker = markersArray[i];
                    let row = document.getElementById(marker.flightId);

                    if (row.style.backgroundColor == "rgb(255, 0, 0)") {
                        row.style.backgroundColor = '#ffccff';
                    }
                }
            });

            showFlightsMarkers(map);
        }

        async function initPageData() {
            await initServers();
            await fetchFlights();
            await fetchFlightPlans();
        }

        async function initServers() {
            const response = await fetch('https://localhost:44308/api/servers')
                .then(response => response.json());
            serversArray = response;
        }

        async function fetchFlights(dateString) {
            let date;

            //dateString ? date = dateString : date = (new Date()).toISOString();
            dateString ? date = dateString : date = '2020-05-24T09:03:50Z';

            //'2020-05-24T09:40:35Z'
            const url = `https://localhost:44308/api/Flights?relative_to=${date}&sync_all`;
            const response = await fetch(url).then(response => response.json());
            flightsArray = response;
        }

        async function deleteFlight(flightId) {
            for (let i = 0; i < flightsArray.length; i++) {
                if (flightId == flightsArray[i].flight_id) {
                    flightsArray.splice(i, 1);
                    deleteFlightByFetch(flightId);
                    removeIrrelevantMarkers();
                }
            }
        }

        async function deleteFlightByFetch(flightId) {
            const url = `https://localhost:44308/api/Flights/${flightId}`;

            return fetch(url, {
                method: 'DELETE',
            }).then(response => response.json());
        }

        function addFlightsMarkersToMap() {
            let props = {};

            for (let i = 0; i < flightsArray.length; i++) {
                props.location = {
                    lat: flightsArray[i].latitude,
                    lng: flightsArray[i].longitude
                };

                props.map = map;
                props.flightId = flightsArray[i].flight_id;

                addMarker(props);
            }
        }

        function updateMarker(marker) {
            let newLatLng;

            for (let i = 0; i < flightsArray.length; i++) {
                if (marker.flightId == flightsArray[i].flight_id) {
                    newLatLng = new google.maps.LatLng(flightsArray[i].latitude, flightsArray[i].longitude);
                    marker.setPosition(newLatLng);
                }
            }
        }

        function addMarker(props) {
            let marker = new google.maps.Marker({
                position: props.location,
                map: props.map,
                flightId: props.flightId
            });

            marker.setIcon('img/blackPlane.png');

            marker.addListener('click', function () {
                //$('#flights-table-body').find('#' + props.flightId).trigger('click');

                markerAndTableClickFunctionallity(marker);
            });

            markersArray.push(marker);
            initFlightsTable();
        }

        function markerAndTableClickFunctionallity(marker) {
            // Handle marker
            if (marker.icon === 'img/blackPlane.png') {
                const flightPlan = flightPlansArray.find(fp => fp.flight_id === marker.flightId);

                initMarkers();
                marker.setIcon('img/coloredPlane.png');
                showFlightPath(flightPlan);
                updateFlightPlanTable(flightPlan);
            } else {
                marker.setIcon('img/blackPlane.png');
                removeFlightPath();
                clearFlightPlanDetailsUl();
            }

            // Handle table

            let row = document.getElementById(marker.flightId);

            if (row.style.backgroundColor == "rgb(255, 0, 0)") {
                row.style.backgroundColor = '#ffccff';
            } else {
                let table = document.getElementById('flights-table-body');

                for (let i = 0; i < table.children.length; i++) {
                    if (table.children[i].style.backgroundColor == "rgb(255, 0, 0)") {
                        table.children[i].style.backgroundColor = '#ffccff';
                    }
                }

                row.style.backgroundColor = 'rgb(255,0,0)';
            }
        }

        async function fetchFlightPlans() {
            let flightId;

            for (let i = 0; i < flightsArray.length; i++) {
                if (!flightPlansArray.some(plan => plan.flight_id === flightsArray[i].flight_id)) {
                    flightId = flightsArray[i].flight_id;
                    //flightId = flightsArray[i].FlightId;
                    const url = 'https://localhost:44308/api/FlightPlan/' + flightId;
                    const response = await fetch(url).then(response => response.json());
                    flightPlansArray.push(response);
                }
            }
        }

        async function showFlightsMarkers() {
            //let date = (new Date()).toISOString();
            //'2020-05-24T09:40:35Z'
            let date = new Date('2020-05-24T09:04:30Z');
            let dateString;

            while (true) {
                dateString = date.toISOString();

                await fetchFlights(dateString);
                await fetchFlightPlans();

                date.setSeconds(date.getSeconds() + 1);

                await sleep(1000);

                handleMarkers();
            }
        }

        function sleep(ms) {
            return new Promise(resolve => setTimeout(resolve, ms));
        }

        function handleMarkers() {
            removeIrrelevantMarkers();

            for (let i = 0; i < flightsArray.length; i++) {
                if (markersArray.some(marker => marker.flightId === flightsArray[i].flight_id)) {
                    updateMarker(markersArray[i]);
                } else {
                    let props = {};

                    props.location = {
                        lat: flightsArray[i].latitude,
                        lng: flightsArray[i].longitude
                    };

                    props.map = map;
                    props.flightId = flightsArray[i].flight_id;

                    addMarker(props);
                }
            }
        }

        function removeIrrelevantMarkers() {
            const markersArrayInitialLength = markersArray.length;

            for (let i = 0; i < markersArrayInitialLength; i++) {
                if (!flightsArray.some(flight => flight.flight_id === markersArray[i].flightId)) {
                    markersArray[i].setMap(null);
                    markersArray.splice(i, 1);
                    removeFlightPath();
                    initFlightsTable();
                    clearFlightPlanDetailsUl();
                    break;
                }
            }
        }

        function showFlightPath(flightPlan) {
            const segments = [];

            segments.push({
                lat: flightPlan.initial_location.latitude,
                lng: flightPlan.initial_location.longitude
            });

            for (let i = 0; i < flightPlan.segments.length; i++) {
                segments.push({
                    lat: flightPlan.segments[i].latitude,
                    lng: flightPlan.segments[i].longitude
                });
            }

            flightPath = new google.maps.Polyline({
                path: segments,
                geodesic: true,
                strokeColor: '#060054',
                strokeOpacity: 1.0,
                strokeWeight: 2
            });

            flightPath.setMap(map);
        }

        function removeFlightPath() {
            if (flightPath) {
                flightPath.setMap(null);
            }
        }

        function initMarkers() {
            for (let i = 0; i < markersArray.length; i++) {
                markersArray[i].setIcon('img/blackPlane.png');
                clearFlightPlanDetailsUl();
            }

            removeFlightPath();
        }

        function updateFlightPlanTable(flightPlan) {
            const boardingLat = flightPlan.initial_location.latitude;
            const boardingLng = flightPlan.initial_location.longitude;
            const landingLat = flightPlan.segments[flightPlan.segments.length - 1].latitude;
            const landingLng = flightPlan.segments[flightPlan.segments.length - 1].longitude;
            const landingTime = calculateLandingTime(flightPlan);

            document.getElementById("flight-id-value").innerHTML = flightPlan.flight_id;
            document.getElementById("boarding-location-value").innerHTML = boardingLat + ', ' + boardingLng;
            document.getElementById("landing-location-value").innerHTML = landingLat + ', ' + landingLng;
            document.getElementById("boarding-time-value").innerHTML = flightPlan.initial_location.date_time;
            document.getElementById("landing-time-value").innerHTML = landingTime;
            document.getElementById("company-name-value").innerHTML = flightPlan.company_name;
            document.getElementById("passengers-value").innerHTML = flightPlan.passengers;

        }

        function calculateLandingTime(flightPlan) {
            let landingTime = new Date(flightPlan.initial_location.date_time);
            let segments = flightPlan.segments;

            for (let i = 0; i < segments.length; i++) {
                landingTime.setSeconds(landingTime.getSeconds() + segments[i].timespan_seconds);
            }

            return landingTime;
        }

        function initFlightsTable() {
            let redRowId;

            if (flightsTableBody.children.length !== 0) {
                for (let i = 0; i < flightsTableBody.children.length; i++) {
                    if (flightsTableBody.children[i].style.backgroundColor == "rgb(255, 0, 0)") {
                        redRowId = flightsTableBody.children[i].id;
                    }
                }
            }

            clearFlightsTable();

            // Show only internal flights
            flightsArray.forEach((flight) => {
                if (!flight.is_external) {
                    addFlightToTableLogic(flight, redRowId);
                }
            });

            // Show only external flights
            flightsArray.forEach((flight) => {
                if (flight.is_external) {
                    addFlightToTableLogic(flight, redRowId);
                }
            });

            handleFlightsTable();
        }

        function addFlightToTableLogic(flight, redRowId) {
            if (flight.flight_id === redRowId) {
                addFligthToTable(flight, redRowId);
            } else {
                addFligthToTable(flight);
            }
        }

        function addFligthToTable(flight, redRowId) {
            const tr = document.createElement("tr");
            tr.setAttribute("id", flight.flight_id);
            if (redRowId) {
                tr.style.backgroundColor = '#ff0000';
            } else {
                tr.style.backgroundColor = '#ffccff';
            }

            // Delete flight
            const td4 = document.createElement("td");
            if (!flight.is_external) {
                td4.innerHTML = "<img src='img/trash.png' alt='hello'/>";
            }
            td4.onclick = function () {
                const flightId = flight.flight_id;

                if (!flight.is_external) {
                    deleteFlight(flightId);
                }
            };
            tr.appendChild(td4);

            //Flight ID
            const td = document.createElement("td");
            td.textContent = flight.flight_id;
            tr.appendChild(td);

            //Company Name
            const td1 = document.createElement("td");
            td1.textContent = flight.company_name;
            tr.appendChild(td1);

            //Boarding Time
            const td2 = document.createElement("td");
            td2.textContent = flight.date_time;
            tr.appendChild(td2);

            //Is External
            const td3 = document.createElement("td");
            td3.textContent = flight.is_external;
            tr.appendChild(td3);


            flightsTableBody.appendChild(tr);
        }

        function clearFlightPlanDetailsUl() {
            document.getElementById("flight-id-value").innerHTML = "";
            document.getElementById("boarding-location-value").innerHTML = "";
            document.getElementById("landing-location-value").innerHTML = "";
            document.getElementById("boarding-time-value").innerHTML = "";
            document.getElementById("landing-time-value").innerHTML = "";
            document.getElementById("company-name-value").innerHTML = "";
            document.getElementById("passengers-value").innerHTML = "";
        }

        function clearFlightsTable() {
            let tableRef = document.getElementById("flights-table");
            while (tableRef.rows.length > 1) {
                tableRef.deleteRow(1);
            }
        }

        function handleFlightsTable() {
            $(document).ready(function () {
                $("#flights-table tbody tr").on("click", function (event) {
                    const marker = markersArray.find(flightMarker => flightMarker.flightId === ($(this).find("td").eq(1).html()));

                    markerAndTableClickFunctionallity(marker);
                });
            });
        }

        function handleRow(marker) {
            let rowFlightId;
            const flightsTable = document.getElementById("flights-table");

            console.log(marker.flightId);

            for (let i = 1, row; row = flightsTable.rows[i]; i++) {
                rowFlightId = row.cells[0].innerHTML;
                if (marker.flightId == rowFlightId) {
                    // If row is red, change to pink and hahefech
                    // Bold row in table
                    row.css("background-color", "red");
                }
            }
        }

        function dragAndDrop() {
            let dropArea = document.getElementById('drop-area');

            ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
                dropArea.addEventListener(eventName, preventDefaults, false);
                //dropArea.addEventListener(eventName, handlerFunction, false);
            });

            ['dragenter', 'dragover'].forEach(eventName => {
                dropArea.addEventListener(eventName, highlight, false);
            });

            ['dragleave', 'drop'].forEach(eventName => {
                dropArea.addEventListener(eventName, unhighlight, false);
            });

            dropArea.addEventListener('drop', handleDrop, false);


            function preventDefaults(e) {
                e.preventDefault();
                e.stopPropagation();
            }

            function highlight(e) {
                dropArea.classList.add('highlight');
            }

            function unhighlight(e) {
                dropArea.classList.remove('highlight');
            }

            function handleDrop(e) {
                let dt = e.dataTransfer;
                let files = dt.files;

                handleFiles(files);
            }

            function handleFiles(files) {
                ([...files]).forEach(uploadFile);
            }

            async function uploadFile(file) {
                fileToText(file, jsonAsText => {
                    const jsonData = JSON.parse(jsonAsText);

                    if (isArray(jsonData)) {
                        for (let i = 0; i < jsonData.length; i++) {
                            sendFlightPlanToServer(jsonData[i]);
                        }
                    } else {
                        sendFlightPlanToServer(jsonData);
                    }
                });

                async function fileToText(file, callback) {
                    const reader = await new FileReader();

                    reader.readAsText(file);
                    reader.onload = () => {
                        callback(reader.result);
                    };
                }

                function isArray(jsonData) {
                    return Object.prototype.toString.call(jsonData) === '[object Array]';
                }

                function sendFlightPlanToServer(flightPlan) {
                    fetch('https://localhost:44308/api/FlightPlan', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify(flightPlan)
                    }).then(res => {
                        if (!res.ok) {
                            (document.getElementById('json-upload-error')).textContent = 'Error Occured: Json File Has A Problem';
                        }
                        else {
                            (document.getElementById('json-upload-error')).textContent = '';
                            console.log(res);
                        }
                    });
                }
            }
        }
    </script>
    <script async defer
            src="https://maps.googleapis.com/maps/api/js?key=AIzaSyBPKnpO09dXaCNjbl5fiW2R16yuodWiRXw&callback=startApplication">
                            //src="https://maps.googleapis.com/maps/api/js?key=AIzaSyBPKnpO09dXaCNjbl5fiW2R16yuodWiRXw&callback=initMap">
    </script>
    <script src="https://unpkg.com/axios/dist/axios.min.js"></script>
</body>
</html>